/**
 * Google Apps Script for Talent Tracker with Weight System
 * Deploy this in your Google Sheet: Extensions > Apps Script
 */

// Configuration
const SHEET_NAME = 'Auditions';
const SHEET_ID = '1r8nevJ24_wmIcHhmGtms6qwT3sJohEMeO9uvqZnMB9g';

// Column mappings
const COLUMNS = {
  ROLE: 1,           // A
  TALENT_NAME: 2,    // B
  AGE: 3,            // C
  GENDER: 4,         // D
  ETHNICITY: 5,      // E
  COUNTRY: 6,        // F
  LINK: 7,           // G
  HEADSHOT: 8,       // H
  OVERALL_RATING: 10, // J
  AVERAGE_RATING: 11, // K
  CLAIRE_RATING: 12,  // L
  OLIVIA_RATING: 13,  // M
  FRAN_RATING: 14,    // N
  VICTOR_RATING: 15,  // O
  LAUREN_RATING: 16,  // P
  CLAIRE_NOTES: 17,   // Q
  OLIVIA_NOTES: 18,   // R
  FRAN_NOTES: 19,     // S
  VICTOR_NOTES: 20,   // T
  LAUREN_NOTES: 21,   // U
  PIM_RATING: 22,     // V
  PIM_NOTES: 23,      // W
  TORBEN_RATING: 24,  // X
  TORBEN_NOTES: 25,   // Y
  CLAIRE_WEIGHT: 27,  // AA
  OLIVIA_WEIGHT: 28,  // AB
  FRAN_WEIGHT: 29,    // AC
  VICTOR_WEIGHT: 30,  // AD
  LAUREN_WEIGHT: 31,  // AE
  PIM_WEIGHT: 32,     // AF
  TORBEN_WEIGHT: 33   // AG
};

// User mappings
const USERS = {
  'Claire': { ratingCol: COLUMNS.CLAIRE_RATING, notesCol: COLUMNS.CLAIRE_NOTES, weightCol: COLUMNS.CLAIRE_WEIGHT },
  'Olivia': { ratingCol: COLUMNS.OLIVIA_RATING, notesCol: COLUMNS.OLIVIA_NOTES, weightCol: COLUMNS.OLIVIA_WEIGHT },
  'Fran': { ratingCol: COLUMNS.FRAN_RATING, notesCol: COLUMNS.FRAN_NOTES, weightCol: COLUMNS.FRAN_WEIGHT },
  'Victor': { ratingCol: COLUMNS.VICTOR_RATING, notesCol: COLUMNS.VICTOR_NOTES, weightCol: COLUMNS.VICTOR_WEIGHT },
  'Lauren': { ratingCol: COLUMNS.LAUREN_RATING, notesCol: COLUMNS.LAUREN_NOTES, weightCol: COLUMNS.LAUREN_WEIGHT },
  'Pim': { ratingCol: COLUMNS.PIM_RATING, notesCol: COLUMNS.PIM_NOTES, weightCol: COLUMNS.PIM_WEIGHT },
  'Torben': { ratingCol: COLUMNS.TORBEN_RATING, notesCol: COLUMNS.TORBEN_NOTES, weightCol: COLUMNS.TORBEN_WEIGHT }
};

/**
 * Handle GET requests
 */
function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: 'Talent Tracker API is running'
  })).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Handle POST requests
 */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    switch (action) {
      case 'getTalentData':
        return ContentService.createTextOutput(JSON.stringify(getTalentData()))
          .setMimeType(ContentService.MimeType.JSON);
          
      case 'updateRating':
        return ContentService.createTextOutput(JSON.stringify(
          updateRating(data.user, data.talentIndex, data.rating, data.notes)
        )).setMimeType(ContentService.MimeType.JSON);
        
      case 'updateNotes':
        return ContentService.createTextOutput(JSON.stringify(
          updateNotes(data.user, data.talentIndex, data.notes)
        )).setMimeType(ContentService.MimeType.JSON);
        
      case 'updateWeight':
        return ContentService.createTextOutput(JSON.stringify(
          updateWeight(data.currentUser, data.targetUser, data.weight)
        )).setMimeType(ContentService.MimeType.JSON);
        
      case 'calculateTeamRating':
        return ContentService.createTextOutput(JSON.stringify(
          calculateTeamRatingForTalent(data.talentIndex)
        )).setMimeType(ContentService.MimeType.JSON);
        
      default:
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: 'Unknown action'
        })).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Get all talent data from the Auditions sheet
 */
function getTalentData() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      throw new Error('Auditions sheet not found');
    }
    
    const data = sheet.getDataRange().getValues();
    
    // Skip header row and return data starting from row 2
    const talentData = data.slice(1).map(row => [
      row[COLUMNS.ROLE - 1] || '',
      row[COLUMNS.TALENT_NAME - 1] || '',
      row[COLUMNS.AGE - 1] || '',
      row[COLUMNS.GENDER - 1] || '',
      row[COLUMNS.ETHNICITY - 1] || '',
      row[COLUMNS.COUNTRY - 1] || '',
      row[COLUMNS.LINK - 1] || '',
      row[COLUMNS.HEADSHOT - 1] || '',
      row[COLUMNS.OVERALL_RATING - 1] || '',
      row[COLUMNS.AVERAGE_RATING - 1] || '',
      row[COLUMNS.CLAIRE_RATING - 1] || '',
      row[COLUMNS.OLIVIA_RATING - 1] || '',
      row[COLUMNS.FRAN_RATING - 1] || '',
      row[COLUMNS.VICTOR_RATING - 1] || '',
      row[COLUMNS.LAUREN_RATING - 1] || '',
      row[COLUMNS.CLAIRE_NOTES - 1] || '',
      row[COLUMNS.OLIVIA_NOTES - 1] || '',
      row[COLUMNS.FRAN_NOTES - 1] || '',
      row[COLUMNS.VICTOR_NOTES - 1] || '',
      row[COLUMNS.LAUREN_NOTES - 1] || '',
      row[COLUMNS.PIM_RATING - 1] || '',
      row[COLUMNS.PIM_NOTES - 1] || '',
      row[COLUMNS.TORBEN_RATING - 1] || '',
      row[COLUMNS.TORBEN_NOTES - 1] || '',
      row[COLUMNS.CLAIRE_WEIGHT - 1] || 1,
      row[COLUMNS.OLIVIA_WEIGHT - 1] || 1,
      row[COLUMNS.FRAN_WEIGHT - 1] || 1,
      row[COLUMNS.VICTOR_WEIGHT - 1] || 1,
      row[COLUMNS.LAUREN_WEIGHT - 1] || 1,
      row[COLUMNS.PIM_WEIGHT - 1] || 1,
      row[COLUMNS.TORBEN_WEIGHT - 1] || 1
    ]);
    
    return { success: true, data: talentData };
  } catch (error) {
    console.error('Error getting talent data:', error);
    return { success: false, error: error.toString() };
  }
}

/**
 * Update rating for a specific user and talent row
 */
function updateRating(user, talentIndex, rating, notes = '') {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const row = talentIndex + 2; // +2 because index is 0-based and we skip header
    
    if (USERS[user]) {
      // Update rating
      sheet.getRange(row, USERS[user].ratingCol).setValue(rating);
      
      // Update notes if provided
      if (notes !== undefined && notes !== null) {
        sheet.getRange(row, USERS[user].notesCol).setValue(notes);
      }
      
      calculateAndUpdateAverage(row);
      return { success: true };
    } else {
      return { success: false, error: 'User not found' };
    }
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

/**
 * Update notes for a specific user and talent row
 */
function updateNotes(user, talentIndex, notes) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const row = talentIndex + 2; // +2 because index is 0-based and we skip header
    
    if (USERS[user]) {
      sheet.getRange(row, USERS[user].notesCol).setValue(notes);
      return { success: true };
    } else {
      return { success: false, error: 'User not found' };
    }
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

/**
 * Update weight for a specific user based on current user's column
 */
function updateWeight(currentUser, targetUser, weight) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    
    if (!USERS[currentUser]) {
      return { success: false, error: 'Current user not found' };
    }
    
    if (!USERS[targetUser]) {
      return { success: false, error: 'Target user not found' };
    }
    
    // Convert weight string to number
    let weightValue = 1; // Default to normal weight
    if (weight === 'Ignore') {
      weightValue = 0;
    } else if (weight === 'Extra Weight') {
      weightValue = 2;
    } else if (weight === 'Normal') {
      weightValue = 1;
    }
    
    // Get the column for the current user (this determines which column to write to)
    const currentUserWeightCol = USERS[currentUser].weightCol;
    
    // Get the row for the target user (Claire=2, Olivia=3, Fran=4, Victor=5, Lauren=6, Pim=7)
    const targetUserRow = getTargetUserRow(targetUser);
    
    // Write the weight value to the current user's column, target user's row
    sheet.getRange(targetUserRow, currentUserWeightCol).setValue(weightValue);
    
    // Weight updates don't need to recalculate averages immediately
    // The averages will be recalculated when ratings are updated
    
    return { success: true };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

/**
 * Get the row number for a target user
 */
function getTargetUserRow(targetUser) {
  const userRows = {
    'Claire': 2,
    'Olivia': 3,
    'Fran': 4,
    'Victor': 5,
    'Lauren': 6,
    'Pim': 7,
    'Torben': 8
  };
  return userRows[targetUser] || 2;
}

/**
 * Calculate team rating for a specific talent using current weights
 */
function calculateTeamRatingForTalent(talentIndex) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      throw new Error('Auditions sheet not found');
    }
    
    const talentRow = talentIndex + 2; // +2 because index is 0-based and we skip header
    
    // Get all ratings and weights
    const ratings = [
      { name: 'Claire', rating: sheet.getRange(talentRow, COLUMNS.CLAIRE_RATING).getValue(), weight: sheet.getRange(2, COLUMNS.CLAIRE_WEIGHT).getValue() || 1 },
      { name: 'Olivia', rating: sheet.getRange(talentRow, COLUMNS.OLIVIA_RATING).getValue(), weight: sheet.getRange(3, COLUMNS.OLIVIA_WEIGHT).getValue() || 1 },
      { name: 'Fran', rating: sheet.getRange(talentRow, COLUMNS.FRAN_RATING).getValue(), weight: sheet.getRange(4, COLUMNS.FRAN_WEIGHT).getValue() || 1 },
      { name: 'Victor', rating: sheet.getRange(talentRow, COLUMNS.VICTOR_RATING).getValue(), weight: sheet.getRange(5, COLUMNS.VICTOR_WEIGHT).getValue() || 1 },
      { name: 'Lauren', rating: sheet.getRange(talentRow, COLUMNS.LAUREN_RATING).getValue(), weight: sheet.getRange(6, COLUMNS.LAUREN_WEIGHT).getValue() || 1 },
      { name: 'Pim', rating: sheet.getRange(talentRow, COLUMNS.PIM_RATING).getValue(), weight: sheet.getRange(7, COLUMNS.PIM_WEIGHT).getValue() || 1 },
      { name: 'Torben', rating: sheet.getRange(talentRow, COLUMNS.TORBEN_RATING).getValue(), weight: sheet.getRange(8, COLUMNS.TORBEN_WEIGHT).getValue() || 1 }
    ];
    
    // Calculate weighted totals
    let yesWeight = 0;
    let noWeight = 0;
    let maybeWeight = 0;
    
    ratings.forEach(rating => {
      // Only count votes that are not empty, null, or undefined
      if (rating.rating && rating.rating.trim() !== '') {
        const weight = rating.weight || 1;
        
        if (rating.rating === 'Yes') {
          yesWeight += weight;
        } else if (rating.rating === 'No') {
          noWeight += weight;
        } else if (rating.rating === 'Maybe') {
          maybeWeight += weight;
        }
      }
    });
    
    // Determine result
    let result = '';
    if (yesWeight === 0 && noWeight === 0 && maybeWeight === 0) {
      result = 'No Votes';
    } else if (yesWeight > noWeight && yesWeight > maybeWeight) {
      result = 'Certified Yes';
    } else if (noWeight > yesWeight && noWeight > maybeWeight) {
      result = 'Certified No';
    } else if (maybeWeight > yesWeight && maybeWeight > noWeight) {
      result = 'Certified Maybe';
    } else {
      result = 'Split Decision';
    }
    
    return { success: true, teamRating: result, weights: { yesWeight, noWeight, maybeWeight } };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

/**
 * Calculate and update the average rating for a specific row using weights
 */
function calculateAndUpdateAverage(row) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      throw new Error('Auditions sheet not found');
    }
    
    // Get all ratings and weights
    const ratings = [
      { name: 'Claire', rating: sheet.getRange(row, COLUMNS.CLAIRE_RATING).getValue(), weight: sheet.getRange(row, COLUMNS.CLAIRE_WEIGHT).getValue() || 1 },
      { name: 'Olivia', rating: sheet.getRange(row, COLUMNS.OLIVIA_RATING).getValue(), weight: sheet.getRange(row, COLUMNS.OLIVIA_WEIGHT).getValue() || 1 },
      { name: 'Fran', rating: sheet.getRange(row, COLUMNS.FRAN_RATING).getValue(), weight: sheet.getRange(row, COLUMNS.FRAN_WEIGHT).getValue() || 1 },
      { name: 'Victor', rating: sheet.getRange(row, COLUMNS.VICTOR_RATING).getValue(), weight: sheet.getRange(row, COLUMNS.VICTOR_WEIGHT).getValue() || 1 },
      { name: 'Lauren', rating: sheet.getRange(row, COLUMNS.LAUREN_RATING).getValue(), weight: sheet.getRange(row, COLUMNS.LAUREN_WEIGHT).getValue() || 1 },
      { name: 'Pim', rating: sheet.getRange(row, COLUMNS.PIM_RATING).getValue(), weight: sheet.getRange(row, COLUMNS.PIM_WEIGHT).getValue() || 1 },
      { name: 'Torben', rating: sheet.getRange(row, COLUMNS.TORBEN_RATING).getValue(), weight: sheet.getRange(row, COLUMNS.TORBEN_WEIGHT).getValue() || 1 }
    ];
    
    // Calculate weighted totals
    let yesWeight = 0;
    let noWeight = 0;
    let maybeWeight = 0;
    
    ratings.forEach(rating => {
      // Only count votes that are not empty, null, or undefined
      if (rating.rating && rating.rating.trim() !== '') {
        const weight = rating.weight || 1;
        
        if (rating.rating === 'Yes') {
          yesWeight += weight;
        } else if (rating.rating === 'No') {
          noWeight += weight;
        } else if (rating.rating === 'Maybe') {
          maybeWeight += weight;
        }
      }
    });
    
    // Determine result
    let result = '';
    if (yesWeight === 0 && noWeight === 0 && maybeWeight === 0) {
      result = 'No Votes';
    } else if (yesWeight > noWeight && yesWeight > maybeWeight) {
      result = 'Certified Yes';
    } else if (noWeight > yesWeight && noWeight > maybeWeight) {
      result = 'Certified No';
    } else if (maybeWeight > yesWeight && maybeWeight > noWeight) {
      result = 'Certified Maybe';
    } else {
      result = 'Split Decision';
    }
    
    // Update columns J and K with the result
    sheet.getRange(row, COLUMNS.OVERALL_RATING).setValue(result);
    sheet.getRange(row, COLUMNS.AVERAGE_RATING).setValue(result);
    
    return result;
  } catch (error) {
    console.error('Error calculating average:', error);
    return '';
  }
}
